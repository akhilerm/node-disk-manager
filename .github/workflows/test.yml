name: test

on: ['push', 'pull_request']

jobs:
  unit-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install dependencies
        run: make install-dep

      - name: Verify Unit Tests
        run: sudo -E env "PATH=$PATH" make test

  integration-test:
    runs-on: ubuntu-latest
    steps:
      - name: Install Test Infra
        run: make install-test-infra

      - name: Start Minikube
        run: |
          sudo minikube start --vm-driver=none;
          sudo minikube update-context;
          sudo chown -R $USER $HOME/.minikube;
          sudo chown -R $USER $HOME/.kube;

      - name: Run Integration Test
        run: make integration-test